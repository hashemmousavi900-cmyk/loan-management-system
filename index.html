<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… ÙˆØ§Ù… - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <style>
        body { font-family: Tahoma; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .btn { background: #27ae60; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #219653; }
        .btn-warning { background: #f39c12; }
        .btn-warning:hover { background: #e67e22; }
        .btn-danger { background: #e74c3c; }
        .btn-danger:hover { background: #c0392b; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù… - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</h1>
        
        <div>
            <button class="btn" onclick="loadFromSheets()">ğŸ”„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Sheets</button>
            <button class="btn btn-warning" onclick="add50TestData()">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛµÛ° Ø±Ú©ÙˆØ±Ø¯ ØªØ³Øª</button>
            <button class="btn" onclick="saveToSheets()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets</button>
            <button class="btn btn-danger" onclick="clearLocalData()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ</button>
        </div>

        <div id="status" style="margin: 10px 0; padding: 10px; border-radius: 5px;"></div>

        <div>
            <strong>Ø¢Ù…Ø§Ø±:</strong>
            <span id="stats">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
        </div>

        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th>
                    <th>Ù†Ø§Ù… Ú©Ø§Ù…Ù„</th>
                    <th>ÙˆØ§Ù… Ø¨Ø§Ù†Ú©ÛŒ</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymE-RILJ8gCg4vLreCz5wchcQrx-mS5HzCmHEpuOu4RMl58Vma3rZlfJ_Ac1XUQzK0/exec';
        let allData = [];

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Sheets
        async function loadFromSheets() {
            showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Ø³Ø±ÙˆØ±...', 'blue');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=loadData`);
                const result = await response.json();
                
                if (result.success) {
                    allData = result.data;
                    renderTable();
                    updateStats();
                    showStatus(`âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø§Ø² Ø³Ø±ÙˆØ± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯: ${result.data.length} Ø±Ú©ÙˆØ±Ø¯`, 'green');
                } else {
                    showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ' + result.error, 'red');
                }
            } catch (error) {
                showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„: ' + error.message, 'red');
            }
        }

      // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets - Ø¨Ø§ chunking Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² POST
async function saveToSheets() {
    if (allData.length === 0) {
        showStatus('âš ï¸ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'orange');
        return;
    }

    showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø± Ø³Ø±ÙˆØ±...', 'blue');
    
    try {
        // ØªÙ‚Ø³ÛŒÙ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ chunks Ú©ÙˆÚ†Ú©
        const CHUNK_SIZE = 10;
        const chunks = [];
        
        for (let i = 0; i < allData.length; i += CHUNK_SIZE) {
            chunks.push(allData.slice(i, i + CHUNK_SIZE));
        }
        
        showStatus(`ğŸ“¦ ØªÙ‚Ø³ÛŒÙ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ ${chunks.length} Ø¨Ø®Ø´...`, 'blue');
        
        let totalSaved = 0;
        let successCount = 0;
        
        // Ø§ÙˆÙ„ Ø´ÛŒØª Ø±Ùˆ Ù¾Ø§Ú© Ú©Ù†
        try {
            const clearResponse = await fetch(SCRIPT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `action=clearSheet`
            });
            const clearResult = await clearResponse.json();
            
            if (clearResult.success) {
                showStatus('ğŸ§¹ Ø´ÛŒØª Ù¾Ø§Ú© Ø´Ø¯ØŒ Ø´Ø±ÙˆØ¹ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...', 'blue');
            } else {
                showStatus('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´ÛŒØªØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª...', 'orange');
            }
        } catch (error) {
            console.log('âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø´ÛŒØª:', error);
        }
        
        // Ø§Ø±Ø³Ø§Ù„ chunks Ø¨Ø§ POST
        for (let i = 0; i < chunks.length; i++) {
            try {
                showStatus(`ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø®Ø´ ${i + 1} Ø§Ø² ${chunks.length}... (${chunks[i].length} Ø±Ú©ÙˆØ±Ø¯)`, 'blue');
                
                const formData = new FormData();
                formData.append('action', 'appendData');
                formData.append('data', JSON.stringify(chunks[i]));
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();

                if (result.success) {
                    totalSaved += chunks[i].length;
                    successCount++;
                    showStatus(`âœ… Ø¨Ø®Ø´ ${i + 1} Ø§Ø² ${chunks.length} Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (${chunks[i].length} Ø±Ú©ÙˆØ±Ø¯)`, 'green');
                } else {
                    showStatus(`âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø®Ø´ ${i + 1}: ${result.error}`, 'orange');
                }
                
                // ÙˆÙ‚ÙÙ‡ Ø¨ÛŒÙ† chunks
                if (i < chunks.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø®Ø´ ${i + 1}: ${error.message}`, 'red');
            }
        }
        
        if (successCount === chunks.length) {
            showStatus(`âœ… Ù‡Ù…Ù‡ ${totalSaved} Ø±Ú©ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯`, 'green');
        } else {
            showStatus(`âš ï¸ ${totalSaved} Ø§Ø² ${allData.length} Ø±Ú©ÙˆØ±Ø¯ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯`, 'orange');
        }
        
    } catch (error) {
        showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ: ' + error.message, 'red');
    }
}

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛµÛ° Ø±Ú©ÙˆØ±Ø¯ ØªØ³ØªÛŒ
        function add50TestData() {
            const newData = [];
            for (let i = 1; i <= 50; i++) {
                newData.push({
                    Username: `testuser${i}`,
                    Employeenumber: `TEST${i.toString().padStart(3, '0')}`,
                    Fullname: `Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª ${i}`,
                    Gender: i % 2 === 0 ? 'Ø²Ù†' : 'Ù…Ø±Ø¯',
                    Bankloan: `${i * 1000000} Ø±ÛŒØ§Ù„`,
                    Companyloan: `${i * 500000} Ø±ÛŒØ§Ù„`,
                    Bankloandate: '2024-01-01',
                    Companyloandate: '2024-01-01',
                    Priority: '2',
                    Description: `ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ³Øª ${i}`,
                    Loanrequest: false
                });
            }
            allData = allData.concat(newData);
            renderTable();
            updateStats();
            showStatus('âœ… ÛµÛ° Ø±Ú©ÙˆØ±Ø¯ ØªØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'green');
        }

        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ
        function clearLocalData() {
            allData = [];
            renderTable();
            updateStats();
            showStatus('âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø­Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯', 'orange');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            allData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.Employeenumber}</td>
                    <td>${item.Fullname}</td>
                    <td>${item.Bankloan}</td>
                    <td>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteItem(${index})">ğŸ—‘ï¸</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ø¢Ù…Ø§Ø±
        function updateStats() {
            document.getElementById('stats').textContent = 
                `ØªØ¹Ø¯Ø§Ø¯ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§: ${allData.length} | Ø­Ø§ÙØ¸Ù‡ Ù…Ø­Ù„ÛŒ`;
        }

        // Ø­Ø°Ù Ø¢ÛŒØªÙ…
        function deleteItem(index) {
            allData.splice(index, 1);
            renderTable();
            updateStats();
            showStatus('âœ… Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯', 'orange');
        }

        // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
        function showStatus(message, color) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.background = color === 'green' ? '#d4edda' : 
                                   color === 'red' ? '#f8d7da' : 
                                   color === 'orange' ? '#fff3cd' : '#d1ecf1';
            status.style.color = color === 'green' ? '#155724' : 
                               color === 'red' ? '#721c24' : 
                               color === 'orange' ? '#856404' : '#0c5460';
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        loadFromSheets();
    </script>
</body>
</html>

