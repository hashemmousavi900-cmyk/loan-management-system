<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÛŒØ³ØªÙ… ÙˆØ§Ù… - Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡</title>
    <style>
        body { font-family: Tahoma; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .btn { background: #27ae60; color: white; border: none; padding: 10px 15px; margin: 5px; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #219653; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f0f0f0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ§Ù… - Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡</h1>
        
        <div>
            <button class="btn" onclick="loadFromSheets()">ğŸ“¥ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Sheets</button>
            <button class="btn" onclick="addTestData()">â• Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Û³Û° Ø±Ú©ÙˆØ±Ø¯ ØªØ³Øª</button>
            <button class="btn" onclick="saveToSheets()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Sheets</button>
        </div>

        <div id="status" style="margin: 10px 0; padding: 10px; background: #e8f5e8; border-radius: 5px;"></div>

        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø³Ù†Ù„ÛŒ</th>
                    <th>Ù†Ø§Ù… Ú©Ø§Ù…Ù„</th>
                    <th>ÙˆØ§Ù… Ø¨Ø§Ù†Ú©ÛŒ</th>
                    <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymE-RILJ8gCg4vLreCz5wchcQrx-mS5HzCmHEpuOu4RMl58Vma3rZlfJ_Ac1XUQzK0/exec';
        let allData = [];

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø² Google Sheets
        async function loadFromSheets() {
            showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...', 'blue');
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=loadData`);
                const result = await response.json();
                
                if (result.success) {
                    allData = result.data;
                    renderTable();
                    showStatus(`Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯: ${result.data.length} Ø±Ú©ÙˆØ±Ø¯`, 'green');
                } else {
                    showStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: ' + result.error, 'red');
                }
            } catch (error) {
                showStatus('Ø®Ø·Ø§: ' + error.message, 'red');
            }
        }

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Google Sheets
        async function saveToSheets() {
            if (allData.length === 0) {
                showStatus('Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', 'orange');
                return;
            }

            showStatus('Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ...', 'blue');
            
            try {
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² JSONP Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ± Ø²Ø¯Ù† CORS
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'saveCallback_' + Date.now();
                    window[callbackName] = resolve;
                    
                    const script = document.createElement('script');
                    script.src = `${SCRIPT_URL}?action=saveData&callback=${callbackName}&data=${encodeURIComponent(JSON.stringify(allData))}`;
                    script.onerror = () => reject(new Error('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„'));
                    document.head.appendChild(script);
                });

                if (result.success) {
                    showStatus(`Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${result.savedCount || allData.length} Ø±Ú©ÙˆØ±Ø¯`, 'green');
                } else {
                    showStatus('Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + result.error, 'red');
                }
            } catch (error) {
                showStatus('Ø®Ø·Ø§: ' + error.message, 'red');
            }
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ø§Ø¯Ù‡ ØªØ³ØªÛŒ
        function addTestData() {
            for (let i = 1; i <= 30; i++) {
                allData.push({
                    Username: `testuser${i}`,
                    Employeenumber: `TEST${i.toString().padStart(3, '0')}`,
                    Fullname: `Ú©Ø§Ø±Ø¨Ø± ØªØ³Øª ${i}`,
                    Gender: i % 2 === 0 ? 'Ø²Ù†' : 'Ù…Ø±Ø¯',
                    Bankloan: `${i * 1000000} Ø±ÛŒØ§Ù„`,
                    Companyloan: `${i * 500000} Ø±ÛŒØ§Ù„`,
                    Bankloandate: '2024-01-01',
                    Companyloandate: '2024-01-01',
                    Priority: '2',
                    Description: `ØªÙˆØ¶ÛŒØ­Ø§Øª ØªØ³Øª ${i}`,
                    Loanrequest: false
                });
            }
            renderTable();
            showStatus('Û³Û° Ø±Ú©ÙˆØ±Ø¯ ØªØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', 'green');
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø¯ÙˆÙ„
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            allData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.Employeenumber}</td>
                    <td>${item.Fullname}</td>
                    <td>${item.Bankloan}</td>
                    <td>
                        <button class="btn" style="background: #e74c3c; padding: 5px 10px;" onclick="deleteItem(${index})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ø­Ø°Ù Ø¢ÛŒØªÙ…
        function deleteItem(index) {
            allData.splice(index, 1);
            renderTable();
            showStatus('Ø±Ú©ÙˆØ±Ø¯ Ø­Ø°Ù Ø´Ø¯', 'orange');
        }

        // Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª
        function showStatus(message, color) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = color === 'green' ? '#27ae60' : 
                               color === 'red' ? '#e74c3c' : 
                               color === 'orange' ? '#f39c12' : '#3498db';
        }

        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        loadFromSheets();
    </script>
</body>
</html>
